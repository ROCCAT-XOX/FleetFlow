{{ define "vehicle/details.html" }}
{{ template "head" .}}
<body class="bg-gray-50 min-h-screen flex flex-col">
{{ template "navigation" .}}

<main class="container mx-auto px-4 py-6 flex-grow">
    <!-- Breadcrumb -->
    <div class="mb-6">
        <nav class="flex" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li><a href="/dashboard" class="text-gray-700 hover:text-blue-600">Dashboard</a></li>
                <li><span class="mx-2 text-gray-500">/</span></li>
                <li><a href="/vehicles" class="text-gray-700 hover:text-blue-600">Fahrzeuge</a></li>
                <li><span class="mx-2 text-gray-500">/</span></li>
                <li class="text-gray-500">{{ .vehicle.brand }} {{ .vehicle.model }}</li>
            </ol>
        </nav>
    </div>

    <!-- Header-Bereich: Integriertes Fahrzeugbild -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <div class="flex items-start gap-6">
            <!-- Linke Seite: Logo + Fahrzeugdaten -->
            <div class="flex items-center gap-4 flex-1">
                <!-- Marken-Logo -->
                <div class="flex-shrink-0">
                    <img id="brand-logo" class="h-12 w-auto"
                         src="/static/assets/{{ .vehicle.brand | lower }}.svg"
                         alt="{{ .vehicle.brand }}"
                         onerror="this.style.display='none'">
                </div>

                <!-- Fahrzeugdaten -->
                <div class="flex-1">
                    <h1 class="text-2xl font-bold text-gray-900">{{ .vehicle.brand }} {{ .vehicle.model }}</h1>
                    <p class="text-gray-500">{{ .vehicle.licensePlate }} • {{ .vehicle.year }}</p>
                    <div class="mt-2">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold
                        {{ if eq .vehicle.status "available" }}bg-green-100 text-green-800{{ end }}
                        {{ if eq .vehicle.status "inuse" }}bg-yellow-100 text-yellow-800{{ end }}
                        {{ if eq .vehicle.status "maintenance" }}bg-red-100 text-red-800{{ end }}">
                        {{ if eq .vehicle.status "available" }}Verfügbar{{ end }}
                        {{ if eq .vehicle.status "inuse" }}In Benutzung{{ end }}
                        {{ if eq .vehicle.status "maintenance" }}In Wartung{{ end }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Rechte Seite: Fahrzeugbild -->
            <div class="flex-shrink-0">
                <div class="relative">
                    <div id="vehicle-image-container"
                         class="w-24 h-24 rounded-lg overflow-hidden bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center cursor-pointer hover:border-gray-400 transition-colors shadow-sm"
                         onclick="openVehicleImageUpload()"
                         title="Klicken Sie hier, um ein Fahrzeugbild hochzuladen">

                        <!-- Fahrzeugbild -->
                        <img id="vehicle-image"
                             class="w-full h-full object-cover hidden"
                             alt="Fahrzeugbild">

                        <!-- Placeholder -->
                        <div id="vehicle-image-placeholder" class="text-center p-2">
                            <svg class="w-8 h-8 text-gray-400 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span class="text-xs text-gray-500 block">Foto</span>
                        </div>
                    </div>

                    <!-- Upload-Fortschritt -->
                    <div id="image-upload-progress" class="absolute inset-0 bg-black bg-opacity-50 rounded-lg hidden items-center justify-center">
                        <div class="text-center">
                            <svg class="animate-spin h-6 w-6 text-white mx-auto mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-white text-xs">Upload...</span>
                        </div>
                    </div>

                    <!-- Bild-Overlay für Aktionen -->
                    <div id="image-overlay" class="absolute inset-0 bg-black bg-opacity-50 rounded-lg hidden items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                        <button onclick="openVehicleImageUpload()"
                                class="p-1 bg-white bg-opacity-20 rounded-full hover:bg-opacity-30 transition-colors"
                                title="Bild ändern">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab-Container -->
    <div id="vehicle-tabs-container">
        <!-- Tabs als Links -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8">
                <a href="?tab=basic" class="vehicle-tab-btn py-4 px-1 border-b-2 font-medium text-sm {{ if eq .tab "basic" }}border-blue-500 text-blue-600{{ else if eq .tab "" }}border-blue-500 text-blue-600{{ else }}border-transparent text-gray-500 hover:text-gray-700{{ end }}">
                Grunddaten
                </a>
                <a href="?tab=usage" class="vehicle-tab-btn py-4 px-1 border-b-2 font-medium text-sm {{ if eq .tab "usage" }}border-blue-500 text-blue-600{{ else }}border-transparent text-gray-500 hover:text-gray-700{{ end }}">
                Nutzung
                </a>
                <a href="?tab=maintenance" class="vehicle-tab-btn py-4 px-1 border-b-2 font-medium text-sm {{ if eq .tab "maintenance" }}border-blue-500 text-blue-600{{ else }}border-transparent text-gray-500 hover:text-gray-700{{ end }}">
                Wartung
                </a>
                <a href="?tab=fuel" class="vehicle-tab-btn py-4 px-1 border-b-2 font-medium text-sm {{ if eq .tab "fuel" }}border-blue-500 text-blue-600{{ else }}border-transparent text-gray-500 hover:text-gray-700{{ end }}">
                Tankkosten
                </a>
                <a href="?tab=images" class="vehicle-tab-btn py-4 px-1 border-b-2 font-medium text-sm {{ if eq .tab "images" }}border-blue-500 text-blue-600{{ else }}border-transparent text-gray-500 hover:text-gray-700{{ end }}">
                Bilder
                </a>
                <a href="?tab=documents" class="vehicle-tab-btn py-4 px-1 border-b-2 font-medium text-sm {{ if eq .tab "documents" }}border-blue-500 text-blue-600{{ else }}border-transparent text-gray-500 hover:text-gray-700{{ end }}">
                Unterlagen
                </a>
                <a href="?tab=financing" class="vehicle-tab-btn py-4 px-1 border-b-2 font-medium text-sm {{ if eq .tab "financing" }}border-blue-500 text-blue-600{{ else }}border-transparent text-gray-500 hover:text-gray-700{{ end }}">
                Finanzierung
                </a>
                <a href="?tab=registration" class="vehicle-tab-btn py-4 px-1 border-b-2 font-medium text-sm {{ if eq .tab "registration" }}border-blue-500 text-blue-600{{ else }}border-transparent text-gray-500 hover:text-gray-700{{ end }}">
                Zulassung
                </a>
                <a href="?tab=statistics" class="vehicle-tab-btn py-4 px-1 border-b-2 font-medium text-sm {{ if eq .tab "statistics" }}border-blue-500 text-blue-600{{ else }}border-transparent text-gray-500 hover:text-gray-700{{ end }}">
                Statistiken
                </a>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            {{ if eq .tab "basic" }}
            {{ template "vehicle/basic_info" . }}
            {{ else if eq .tab "financing" }}
            {{ template "vehicle/financing" . }}
            {{ else if eq .tab "usage" }}
            {{ template "vehicle/current_usage" . }}
            {{ template "vehicle/usage_history" . }}
            {{ else if eq .tab "maintenance" }}
            {{ template "vehicle/maintenance" . }}
            {{ else if eq .tab "fuel" }}
            {{ template "vehicle/fuel_costs" . }}
            {{ else if eq .tab "images" }}
            {{ template "vehicle/images" . }}
            {{ else if eq .tab "documents" }}
            {{ template "vehicle/documents" . }}
            {{ else if eq .tab "registration" }}
            {{ template "vehicle/registration" . }}
            {{ else if eq .tab "statistics" }}
            {{ template "vehicle/statistics" . }}
            {{ else }}
            {{ template "vehicle/basic_info" . }}
            {{ end }}
        </div>
    </div>
</main>

<!-- Hidden File Input für Bildupload -->
<input type="file" id="vehicle-image-input" accept="image/*" style="display: none;">

<!-- Modals -->
{{ template "vehicle/modals" . }}

<!-- Scripts - RICHTIGE Reihenfolge -->
<!-- Core-Scripts zuerst -->
<script src="/static/js/vehicle-modals.js"></script>
<script src="/static/js/vehicle-image.js"></script>
<script src="/static/js/vehicle-details.js"></script>

<!-- Tab-spezifische Scripts nur bei Bedarf -->
{{ if eq .tab "documents" }}
<script src="/static/js/vehicle-documents.js"></script>
{{ end }}

{{ if eq .tab "images" }}
<script src="/static/js/vehicle-images.js"></script>
{{ end }}

{{ if eq .tab "statistics" }}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="/static/js/vehicle-statistics.js"></script>
{{ end }}

<script>
    // Initialisierung beim Seitenladen
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Vehicle details page loaded');

        // WICHTIG: Globale Funktionen sofort verfügbar machen
        if (typeof openVehicleImageUpload === 'undefined') {
            console.warn('openVehicleImageUpload not defined, creating fallback');
            window.openVehicleImageUpload = function() {
                const fileInput = document.getElementById('vehicle-image-input');
                if (fileInput) {
                    fileInput.click();
                } else {
                    console.error('vehicle-image-input not found');
                }
            };
        }

        // Logo setzen
        const brandLogo = document.getElementById('brand-logo');
        if (brandLogo) {
            const brand = '{{ .vehicle.brand }}'.toLowerCase();
            if (brand) {
                const logoPath = `/static/assets/${brand}.svg`;
                brandLogo.src = logoPath;
                brandLogo.alt = '{{ .vehicle.brand }}';

                brandLogo.onload = function() {
                    brandLogo.style.display = 'block';
                };

                brandLogo.onerror = function() {
                    brandLogo.src = `/static/assets/logo/${brand}.png`;
                    brandLogo.onerror = function() {
                        brandLogo.style.display = 'none';
                    };
                };
            }
        }

        // Tab-spezifische Initialisierung
        const currentTab = '{{ .tab }}' || 'basic';

        // Initialisierung je nach Tab
        if (currentTab === 'documents' && typeof VehicleDocuments !== 'undefined') {
            setTimeout(() => VehicleDocuments.initialize(), 100);
        }

        if (currentTab === 'images' && typeof VehicleGallery !== 'undefined') {
            setTimeout(() => VehicleGallery.initialize(), 100);
        }

        // Fahrzeugbild initialisieren
        if (typeof VehicleImage !== 'undefined' && VehicleImage.loadVehicleImage) {
            VehicleImage.vehicleId = '{{ .vehicleId }}';
            setTimeout(() => VehicleImage.loadVehicleImage(), 200);
        }
    });

    // Debug-Funktion
    function debugVehicleImage() {
        console.log('=== Vehicle Image Debug ===');
        console.log('openVehicleImageUpload available:', typeof openVehicleImageUpload);
        console.log('VehicleImage available:', typeof VehicleImage);
        console.log('File input exists:', !!document.getElementById('vehicle-image-input'));
        console.log('Image container exists:', !!document.getElementById('vehicle-image-container'));
        console.log('Vehicle ID:', '{{ .vehicleId }}');
    }

    // Debug-Funktion global verfügbar machen
    window.debugVehicleImage = debugVehicleImage;
</script>

{{ template "footer" .}}
</body>
</html>
{{ end }}